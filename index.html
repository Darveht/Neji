<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Naruto Characters 3D</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;}
    canvas{display:block;}
    @keyframes ninja-scroll {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes chakra-pulse {
      0% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 0.4; }
      100% { transform: scale(1); opacity: 0.8; }
    }
    #loading{
      position:fixed;width:100%;height:100%;
      background:#000 url('https://i.imgur.com/XqwUZ0r.jpg') center/cover;
      color:#ff4500;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      z-index:100;
      font-family: 'ninja', Arial, sans-serif;
      text-shadow: 0 0 10px #ff4500;
    }
    #loading-bar{
      width:200px;height:20px;
      border:2px solid #ff4500;
      margin-top:20px;
      position: relative;
      overflow: hidden;
      background: rgba(0,0,0,0.5);
    }
    #loading-progress{
      width:0%;height:100%;
      background: linear-gradient(90deg, #ff4500, #ffa500);
      transition:width 0.3s;
      position: relative;
    }
    #loading-progress::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: ninja-scroll 1s infinite;
    }
    #char-select{
      position:fixed;width:100%;height:100%;
      background:rgba(0,0,0,0.9);
      display:none;
      align-items:center;justify-content:center;
      z-index:50;
    }
    .char-card{
      width:200px;margin:20px;
      background:rgba(255,255,255,0.1);
      border:2px solid #fff;
      padding:15px;
      text-align:center;
      color:#fff;
      cursor:pointer;
      transition:transform 0.2s;
    }
    .char-card:hover{
      transform:scale(1.05);
    }
    .char-img{
      width:150px;height:150px;
      background:#333;
      margin:10px auto;
    }
    #joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;touch-action:none;z-index:10;}
    #joy-base,#joy-thumb{position:absolute;border-radius:50%;pointer-events:none;}
    #joy-base{width:100%;height:100%;border:2px solid rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);}
    #joy-thumb{width:50px;height:50px;top:35px;left:35px;background:rgba(255,255,255,0.6);border:2px solid #fff;}
    #actions{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:10;user-select:none;}
    .action-btn{width:60px;height:60px;border-radius:50%;text-align:center;line-height:60px;color:#fff;font-size:12px;
               background:rgba(0,0,0,0.4);border:2px solid #fff;touch-action:none;}
    #jump{border-color:#0f0;color:#0f0;}
    .health-back,.health-bar{position:absolute;width:50px;height:6px;transform:translate(-50%,-120%);pointer-events:none;}
    .health-back{background:rgba(0,0,0,0.5);} .health-bar{background:lime;}
  </style>
</head>
<body>
  <!-- Pantalla de carga -->
  <div id="loading">
    <h2>Cargando...</h2>
    <div id="loading-bar">
      <div id="loading-progress"></div>
    </div>
  </div>

  <!-- Selección de personaje -->
  <div id="char-select">
    <div class="char-card" onclick="selectCharacter('neji')">
      <h3>Neji Hyūga</h3>
      <div class="char-img"></div>
      <p>Poderes: Byakugan, Jūken, 64 Palmas, 128 Palmas, Kaiten</p>
    </div>
    <div class="char-card" onclick="selectCharacter('itachi')">
      <h3>Itachi Uchiha</h3>
      <div class="char-img"></div>
      <p>Poderes: Sharingan, Amaterasu, Tsukuyomi, Susanoo</p>
    </div>
  </div>

  <!-- Joystick -->
  <div id="joystick">
    <div id="joy-base"></div>
    <div id="joy-thumb"></div>
  </div>

  <!-- Botones (se actualizarán según el personaje) -->
  <div id="actions"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script>
  // Variables globales
  let scene, camera, renderer, player, floor;
  let enemies = [], powers = [], moveDir={x:0,z:0}, velY=0, onGround=true;
  const GRAV=-0.02, enemyHUD={};
  let currentCharacter = '';

  // Simular carga
  window.onload = () => {
    let progress = 0;
    const loadingBar = document.getElementById('loading-progress');
    const interval = setInterval(() => {
      progress += 5;
      loadingBar.style.width = progress + '%';
      if(progress >= 100) {
        clearInterval(interval);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('char-select').style.display = 'flex';
      }
    }, 100);
  };

  function selectCharacter(char) {
    currentCharacter = char;
    document.getElementById('char-select').style.display = 'none';

    // Configurar botones según el personaje
    const actions = document.getElementById('actions');
    actions.innerHTML = '';

    const addButton = (id, text) => {
      const btn = document.createElement('div');
      btn.id = id;
      btn.className = 'action-btn';
      btn.textContent = text;
      actions.appendChild(btn);
      return btn;
    };

    addButton('jump', 'Jump');

    if(char === 'neji') {
      addButton('btn-byak', 'Byakugan').addEventListener('touchstart', activateByakugan);
      addButton('btn-juken', 'Jūken').addEventListener('touchstart', activateJuken);
      addButton('btn-64', '64P').addEventListener('touchstart', activate64Palms);
      addButton('btn-128', '128P').addEventListener('touchstart', activate128Palms);
      addButton('btn-kaiten', 'Kaiten').addEventListener('touchstart', activateKaiten);
      addButton('btn-kusho', 'Kūshō').addEventListener('touchstart', activateKusho);
      addButton('btn-det', 'Detect').addEventListener('touchstart', activateDetect);
    } else if(char === 'itachi') {
      addButton('btn-sharingan', 'Sharingan').addEventListener('touchstart', activateSharingan);
      addButton('btn-amaterasu', 'Amaterasu').addEventListener('touchstart', activateAmaterasu);
      addButton('btn-tsukuyomi', 'Tsukuyomi').addEventListener('touchstart', activateTsukuyomi);
      addButton('btn-susanoo', 'Susanoo').addEventListener('touchstart', activateSusanoo);
    }

    init();
    animate();
  }

  function init(){
    scene=new THREE.Scene(); scene.background=new THREE.Color(0x87CEEB);
    camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,500);
    camera.position.set(0,5,10);
    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth,innerHeight);
    document.body.appendChild(renderer.domElement);

    // luces
    scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));
    let dl=new THREE.DirectionalLight(0xffffff,0.8);
    dl.position.set(5,10,7); scene.add(dl);

    // suelo + hierba (idéntico)
    floor=new THREE.Mesh(
      new THREE.PlaneGeometry(200,200),
      new THREE.MeshStandardMaterial({color:0x228B22})
    ); floor.rotation.x=-Math.PI/2; scene.add(floor);
    for(let i=0;i<500;i++){
      let b=new THREE.Mesh(
        new THREE.CylinderGeometry(0.02,0.02,0.6),
        new THREE.MeshStandardMaterial({color:0x00aa00})
      );
      b.position.set(Math.random()*180-90,0.3,Math.random()*180-90);
      b.rotation.z=(Math.random()-0.5)*0.5;
      scene.add(b);
    }

    // personaje
    let body=new THREE.Mesh(
      new THREE.CylinderGeometry(0.6,0.6,2.5),
      new THREE.MeshStandardMaterial({color:0xeeeeee})
    );
    let head=new THREE.Mesh(
      new THREE.SphereGeometry(0.6),
      new THREE.MeshStandardMaterial({color:0xdddddd})
    );
    head.position.y=1.8;
    player=new THREE.Group(); player.add(body,head);
    player.position.set(0,1.25,0); scene.add(player);

    // enemigos
    for(let i=0;i<5;i++) addEnemy();

    // joystick
    const joy=document.getElementById('joystick'),
          thumb=document.getElementById('joy-thumb');
    let origin={x:0,y:0}, tracking=false;
    joy.addEventListener('touchstart',e=>{
      let t=e.touches[0];
      const rect=joy.getBoundingClientRect();
      origin={x:rect.left+rect.width/2,y:rect.top+rect.height/2};
      tracking=true;
    });
    joy.addEventListener('touchmove',e=>{
      if(!tracking) return;
      let t=e.touches[0],
          dx=t.clientX-origin.x,
          dy=t.clientY-origin.y,
          dist=Math.hypot(dx,dy),
          max=50;
      if(dist>max){ dx*=max/dist; dy*=max/dist; }
      thumb.style.transform=`translate(${dx}px,${dy}px)`;
      moveDir.x=dx/max*0.15; moveDir.z=dy/max*0.15;
    });
    joy.addEventListener('touchend',()=>{
      tracking=false;
      thumb.style.transform='translate(0,0)';
      moveDir={x:0,z:0};
    });

    // botones
    document.getElementById('jump')
      .addEventListener('touchstart',_=>{ if(onGround){velY=0.5;onGround=false;}});

    window.addEventListener('resize',()=>{
      camera.aspect=innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
    });
  }

  function addEnemy(){
    let g=new THREE.Group();
    let b=new THREE.Mesh(
      new THREE.BoxGeometry(1,1.5,1),
      new THREE.MeshStandardMaterial({color:0xAA0000})
    );
    let h=new THREE.Mesh(
      new THREE.SphereGeometry(0.5),
      new THREE.MeshStandardMaterial({color:0xFF4444})
    );
    h.position.y=1.25;
    g.add(b,h);
    g.position.set(Math.random()*40-20,0.75,Math.random()*40-20);
    g.userData={hp:200,id:THREE.MathUtils.generateUUID()};
    scene.add(g); enemies.push(g);
    // HUD
    let back=document.createElement('div'),
        bar=document.createElement('div');
    back.className='health-back'; bar.className='health-bar';
    document.body.appendChild(back); document.body.appendChild(bar);
    enemyHUD[g.userData.id]={back,bar};
  }

  function animate(){
    requestAnimationFrame(animate);
    // movimiento + salto
    player.position.x+=moveDir.x; player.position.z+=moveDir.z;
    velY+=GRAV; player.position.y+=velY;
    if(player.position.y<=1.25){player.position.y=1.25;velY=0;onGround=true;}
    // cámara
    camera.position.set(player.position.x+6,player.position.y+4,player.position.z+8);
    camera.lookAt(player.position);
    // poderes y colisiones (como antes)...
    powers.forEach((p,i)=>{
      p.mesh.position.add(p.vel);
      p.life--;
      enemies.forEach(e=>{
        if(p.life>0 && p.mesh.position.distanceTo(e.position)<1.2){
          e.userData.hp-=p.damage; p.life=0; flash(e.position);
        }
      });
      if(p.life<=0){ scene.remove(p.mesh); powers.splice(i,1); }
    });
    // IA enemigos + HUD + muerte
    enemies.forEach((e,i)=>{
      let dir=player.position.clone().sub(e.position).setY(0).normalize().multiplyScalar(0.005);
      e.position.add(dir);
      let {back,bar}=enemyHUD[e.userData.id],
          vp=e.position.clone().project(camera),
          x=(vp.x*0.5+0.5)*innerWidth,
          y=(-vp.y*0.5+0.5)*innerHeight;
      back.style.transform=`translate(${x}px,${y}px)`;
      bar.style.transform=`translate(${x}px,${y}px) scaleX(${e.userData.hp/200})`;
      if(e.userData.hp<=0){
        scene.remove(e); back.remove(); bar.remove();
        enemies.splice(i,1); delete enemyHUD[e.userData.id];
      }
    });
    renderer.render(scene,camera);
  }

  function flash(pos){
    let m=new THREE.Mesh(
      new THREE.SphereGeometry(0.5,8,8),
      new THREE.MeshBasicMaterial({color:0xffff00})
    );
    m.position.copy(pos); scene.add(m);
    setTimeout(()=>scene.remove(m),200);
  }

  // ─── TÉCNICAS ───

  function activateByakugan(){
    // pupilas blancas + venas (overlay CSS)
    let ov=document.createElement('div');
    ov.style.cssText=`
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(255,255,255,0.2);
      pointer-events:none;mix-blend-mode:overlay;
      mask: radial-gradient(circle at 50% 40%, transparent 20%, black 30%);
    `;
    document.body.appendChild(ov);
    setTimeout(()=>ov.remove(),1200);
    // auras en enemigos
    enemies.forEach(e=>{
      let aura=new THREE.Mesh(
        new THREE.RingGeometry(1.5,2.5,32),
        new THREE.MeshBasicMaterial({color:0x00ffff,side:THREE.DoubleSide,transparent:true,opacity:0.3})
      );
      aura.rotation.x=-Math.PI/2;
      aura.position.copy(e.position).add(new THREE.Vector3(0,1,0));
      scene.add(aura);
      setTimeout(()=>scene.remove(aura),1200);
    });
  }

  function activateJuken(){
    // golpe suave: pulso puntual
    let p=new THREE.Mesh(
      new THREE.SphereGeometry(0.5,16,16),
      new THREE.MeshBasicMaterial({color:0xffa500,transparent:true,opacity:0.8})
    );
    p.position.copy(player.position).add(new THREE.Vector3(0,1,0));
    scene.add(p);
    powers.push({mesh:p,vel:new THREE.Vector3(0,0,-1),life:40,damage:50});
  }

  function activate64Palms(){
    for(let i=0;i<64;i++){
      let a=(i/64)*Math.PI*2;
      let orb=new THREE.Mesh(
        new THREE.SphereGeometry(0.15,8,8),
        new THREE.MeshBasicMaterial({color:0x66ccff})
      );
      orb.position.copy(player.position).add(new THREE.Vector3(0,1,0));
      scene.add(orb);
      powers.push({
        mesh:orb,
        vel:new THREE.Vector3(Math.cos(a)*0.7,0,Math.sin(a)*0.7),
        life:50,damage:10
      });
    }
  }

  function activate128Palms(){
    for(let i=0;i<128;i++){
      let a=(i/128)*Math.PI*2;
      let orb=new THREE.Mesh(
        new THREE.SphereGeometry(0.12,8,8),
        new THREE.MeshBasicMaterial({color:0x00ffff})
      );
      orb.position.copy(player.position).add(new THREE.Vector3(0,1,0));
      scene.add(orb);
      powers.push({
        mesh:orb,
        vel:new THREE.Vector3(Math.cos(a)*0.9,0,Math.sin(a)*0.9),
        life:40,damage:8
      });
    }
  }

  function activateKaiten(){
    let t=new THREE.Mesh(
      new THREE.TorusGeometry(3,0.4,16,100),
      new THREE.MeshBasicMaterial({color:0x99ccff,transparent:true,opacity:0.4})
    );
    t.rotation.x=Math.PI/2; player.add(t);
    let cnt=0, iv=setInterval(()=>{
      t.rotation.z+=0.6;
      enemies.forEach(e=>{
        if(t.getWorldPosition(new THREE.Vector3()).distanceTo(e.position)<3)
          e.userData.hp-=3;
      });
      if(++cnt>30){ clearInterval(iv); player.remove(t); }
    },40);
  }

  function activateKusho(){
    // onda de vacío
    let ring=new THREE.Mesh(
      new THREE.RingGeometry(0.5,0.7,32),
      new THREE.MeshBasicMaterial({color:0xff00ff,side:THREE.DoubleSide,transparent:true,opacity:0.6})
    );
    ring.rotation.x=-Math.PI/2;
    ring.position.copy(player.position);
    scene.add(ring);
    let scale=1, iv=setInterval(()=>{
      scale+=0.5;
      ring.scale.set(scale,scale,scale);
      ring.material.opacity-=0.05;
      enemies.forEach(e=>{
        if(e.position.distanceTo(player.position)<scale*1.2)
          e.userData.hp-=4;
      });
      if(scale>6){ clearInterval(iv); scene.remove(ring); }
    },50);
  }

  function activateDetect(){
    // identifica clones/ilusiones: parpadea a los enemigos ocultos
    enemies.forEach(e=>{
      let highlight=new THREE.Mesh(
        new THREE.SphereGeometry(1.8,16,16),
        new THREE.MeshBasicMaterial({color:0xffff00,wireframe:true,transparent:true,opacity:0.5})
      );
      highlight.position.copy(e.position);
      scene.add(highlight);
      setTimeout(()=>scene.remove(highlight),1500);
    });
  }

  // Nuevos poderes de Itachi
  function activateSharingan() {
    // Efecto visual de ojos rojos
    let overlay = document.createElement('div');
    overlay.style.cssText = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(255,0,0,0.1);
      pointer-events:none;mix-blend-mode:overlay;
      mask: radial-gradient(circle at 50% 40%, transparent 20%, black 30%);
    `;
    document.body.appendChild(overlay);
    setTimeout(() => overlay.remove(), 1200);

    // Marcar enemigos
    enemies.forEach(e => {
      let aura = new THREE.Mesh(
        new THREE.RingGeometry(1.5,2.5,32),
        new THREE.MeshBasicMaterial({color:0xff0000,side:THREE.DoubleSide,transparent:true,opacity:0.3})
      );
      aura.rotation.x = -Math.PI/2;
      aura.position.copy(e.position).add(new THREE.Vector3(0,1,0));
      scene.add(aura);
      setTimeout(() => scene.remove(aura), 1200);
    });
  }

  function activateAmaterasu() {
    let flame = new THREE.Mesh(
      new THREE.SphereGeometry(0.5),
      new THREE.MeshBasicMaterial({color:0x000000})
    );
    flame.position.copy(player.position).add(new THREE.Vector3(0,1,0));
    scene.add(flame);
    powers.push({
      mesh: flame,
      vel: new THREE.Vector3(0,0,-1),
      life: 60,
      damage: 100
    });
  }

  function activateTsukuyomi() {
    // Efecto visual mejorado de Tsukuyomi
    let overlay = document.createElement('div');
    overlay.style.cssText = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      background: url('https://i.imgur.com/XqwUZ0r.jpg') center/cover;
      opacity:0;pointer-events:none;
      transition:all 0.5s;
      animation: tsukuyomi-world 2s forwards;
    `;
    
    const style = document.createElement('style');
    style.textContent = `
      @keyframes tsukuyomi-world {
        0% { filter: hue-rotate(0deg) invert(0); transform: scale(1); }
        50% { filter: hue-rotate(180deg) invert(1); transform: scale(1.1); }
        100% { filter: hue-rotate(360deg) invert(0); transform: scale(1); }
      }
      @keyframes sharingan-spin {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
    
    // Añadir Sharingan giratorio
    let sharingan = document.createElement('div');
    sharingan.style.cssText = `
      position:fixed;
      top:50%;left:50%;
      width:200px;height:200px;
      background: url('https://i.imgur.com/1234567.png') center/cover;
      animation: sharingan-spin 2s linear infinite;
      z-index:1000;
      pointer-events:none;
    `;
    
    document.body.appendChild(overlay);
    document.body.appendChild(sharingan);
    
    // Efecto de sonido
    let tsukuyomiSound = new Audio('https://example.com/tsukuyomi.mp3');
    tsukuyomiSound.play();
    
    setTimeout(() => {
      overlay.style.opacity = '0.9';
      // Efecto de distorsión de tiempo
      scene.fog = new THREE.FogExp2(0xff0000, 0.1);
    }, 100);
    
    setTimeout(() => {
      overlay.style.opacity = '0';
      sharingan.remove();
      scene.fog = null;
      setTimeout(() => {
        overlay.remove();
        style.remove();
      }, 500);
    }, 2000);

    // Daño mejorado a enemigos
    enemies.forEach(e => {
      if(e.position.distanceTo(player.position) < 5) {
        e.userData.hp -= 150;
        // Efecto visual de daño
        let flash = new THREE.Mesh(
          new THREE.SphereGeometry(2),
          new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.5
          })
        );
        flash.position.copy(e.position);
        scene.add(flash);
        setTimeout(() => scene.remove(flash), 500);
      }
    });
  }

  function activateSusanoo() {
    let susanoo = new THREE.Group();
    // Crear forma básica del Susanoo
    let body = new THREE.Mesh(
      new THREE.CylinderGeometry(2,2,4),
      new THREE.MeshBasicMaterial({color:0xff0000,transparent:true,opacity:0.3})
    );
    susanoo.add(body);
    player.add(susanoo);

    let cnt = 0, iv = setInterval(() => {
      enemies.forEach(e => {
        if(e.position.distanceTo(player.position) < 4) {
          e.userData.hp -= 5;
        }
      });
      if(++cnt > 50) {
        clearInterval(iv);
        player.remove(susanoo);
      }
    }, 100);
  }
  </script>
</body>
</html>
